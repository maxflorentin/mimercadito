<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>miMercadito</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">

  <!-- Estilos (Standalone / GitHub Pages) -->
  <link rel="stylesheet" href="style.css">

  <!-- Estilos (Google Apps Script - Inyectado al desplegar) -->
  <? if (typeof include !== 'undefined') { ?>
  <?!= include('theme') ?>
  <? } ?>
</head>

<body>

  <!-- Navbar -->
  <div class="preview-nav">
    <div class="preview-brand">miMercadito <span>¬∑ inventory</span></div>
    <div class="tab-group">
      <button class="tab-btn active" onclick="showView('dashboard')" id="btn-nav-dashboard">Dashboard</button>
      <button class="tab-btn" onclick="showView('formulario')" id="btn-nav-formulario">Nuevo</button>
    </div>
  </div>

  <div class="page" id="view-dashboard">
    <div class="stat-grid" style="margin-bottom:var(--sp-5);">
      <div class="stat-card">
        <p class="stat-label">Disponible</p>
        <p class="stat-value" id="stat-pending">‚Äî</p>
      </div>
      <div class="stat-card">
        <p class="stat-label">Vendidos</p>
        <p class="stat-value text-accent" id="stat-sold">‚Äî</p>
      </div>
      <div class="stat-card">
        <p class="stat-label">$ Stock</p>
        <p class="stat-value" id="stat-stock">‚Äî</p>
      </div>
      <div class="stat-card">
        <p class="stat-label">Ingreso ventas</p>
        <p class="stat-value text-success" id="stat-profit">‚Äî</p>
      </div>
      <div class="stat-card">
        <p class="stat-label">Prom. d√≠as stock</p>
        <p class="stat-value text-warning" id="stat-avgdays">‚Äî</p>
      </div>
    </div>

    <div class="card" style="padding:0;overflow:hidden;">
      <div class="flex items-center justify-between"
        style="padding:var(--sp-5) var(--sp-5) var(--sp-4);flex-wrap:wrap;gap:var(--sp-3);">
        <p class="text-subtitle">Productos</p>
        <div class="toolbar">
          <div class="search-wrap" style="position:relative;flex:1;min-width:140px;">
            <svg width="13" height="13" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"
              style="position:absolute;left:10px;top:50%;transform:translateY(-50%);color:var(--color-text-tertiary);pointer-events:none;">
              <circle cx="11" cy="11" r="8" />
              <path d="m21 21-4.35-4.35" />
            </svg>
            <input type="text" class="search-input" placeholder="Buscar‚Ä¶" oninput="applyFilters()" id="search-input" />
          </div>
          <div class="filter-wrap">
            <select class="filter-select" onchange="applyFilters()" id="filter-status">
              <option value="">Todos</option>
              <option value="Pending">Disponible</option>
              <option value="Sold">Vendidos</option>
              <option value="Deleted">Archivados</option>
            </select>
          </div>
          <span id="table-count" class="badge badge-neutral">‚Äî items</span>
        </div>
      </div>
      <div style="border-top:1px solid var(--color-border);overflow-x:auto;">
        <table class="data-table">
          <thead>
            <tr>
              <th>Producto</th>
              <th>Categor√≠a</th>
              <th>Costo</th>
              <th>Lista / Piso</th>
              <th>Margen</th>
              <th>D√≠as</th>
              <th>Estado</th>
              <th></th>
            </tr>
          </thead>
          <tbody id="tableBody">
            <tr>
              <td colspan="8" style="text-align:center;color:var(--color-text-tertiary);padding:36px;">‚è≥ Conectando al
                inventario‚Ä¶</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <div class="page-narrow" id="view-formulario" style="display:none; margin-top: var(--sp-8);">
    <div style="margin-bottom:var(--sp-6);">
      <h1 class="text-title" id="form-title">Nuevo producto</h1>
      <p class="text-secondary" style="font-size:var(--text-sm);margin-top:2px;">Carg√° los datos del nuevo item.</p>
    </div>

    <div class="card">
      <form id="productForm" class="flex flex-col gap-4">
        <input type="hidden" name="editingIdx" id="form-editing-idx" value="" />
        <div class="form-group">
          <label class="form-label">Nombre del producto</label>
          <input type="text" name="productName" class="form-control" placeholder="MacBook Pro, iPhone 15‚Ä¶" required />
        </div>
        <div class="grid-2">
          <div class="form-group"><label class="form-label">Categor√≠a</label><select name="category"
              class="form-select form-control">
              <option>Electronics</option>
              <option>Home</option>
              <option>Fashion</option>
              <option>Other</option>
            </select></div>
          <div class="form-group"><label class="form-label">Estado (1‚Äì10)</label><input type="number" name="condition"
              class="form-control" min="1" max="10" value="10" /></div>
        </div>
        <div class="grid-3">
          <div class="form-group"><label class="form-label">Costo ($)</label><input type="number" name="costPrice"
              class="form-control" placeholder="0" /></div>
          <div class="form-group"><label class="form-label">P. Lista ($)</label><input type="number" name="publicPrice"
              class="form-control" required /></div>
          <div class="form-group"><label class="form-label">P. Piso ($)</label><input type="number" name="minPrice"
              class="form-control" required /></div>
        </div>
        <div class="form-group"><label class="form-label">Notas</label><input type="text" name="notes"
            class="form-control" /></div>
        <div class="form-group">
          <label class="form-label">Foto</label>
          <label for="photo" class="btn btn-secondary w-full"
            style="height:auto;padding:16px;border-style:dashed;flex-direction:column;gap:var(--sp-2);">
            <svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
              <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z" />
              <circle cx="12" cy="13" r="4" />
            </svg>
            <span id="photo-label">Sacar foto</span>
            <input type="file" id="photo" style="display:none;" accept="image/*" capture="environment"
              onchange="previewImage(this)" />
          </label>
          <div id="image-preview-container" style="display:none;margin-top:var(--sp-2);position:relative;">
            <img id="image-preview" src="" style="width:100%;border-radius:var(--r-md);display:none;" />
            <div id="image-link-container"
              style="display:none; padding: 16px; background: var(--color-bg); border-radius: var(--r-md); text-align: center; border: 1px solid var(--color-border);">
              <a id="image-direct-link" href="#" target="_blank"
                style="color: var(--color-accent); text-decoration: none; font-weight: 500; font-size: var(--text-sm); display: flex; align-items: center; justify-content: center; gap: 8px;">
                <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                  <path d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
                </svg>
                Ver foto actual
              </a>
            </div>
            <button type="button" onclick="clearPhoto()"
              style="position:absolute;top:8px;right:8px;background:rgba(0,0,0,0.5);color:white;border:none;border-radius:50%;width:24px;height:24px;">‚úï</button>
          </div>
        </div>
        <button type="button" id="submitBtn" class="btn btn-primary w-full" onclick="startUpload()">Guardar
          producto</button>
        <div id="status" style="min-height:36px;text-align:center;"></div>
      </form>
    </div>
  </div>

  <div class="modal-overlay" id="modal-overlay" onclick="handleOverlayClick(event)">
    <div class="modal" id="modal">
      <div class="modal-header">
        <p class="modal-title" id="modal-title">‚Äî</p>
        <p class="modal-subtitle" id="modal-subtitle"></p>
      </div>
      <div class="modal-body" id="modal-body"></div>
      <div class="modal-footer" id="modal-footer"></div>
    </div>
  </div>
  <div class="toast-stack" id="toast-stack"></div>

  <script>
    /**
     * CONFIGURACI√ìN UNIVERSAL
     * GitHub Actions reemplazar√° estos valores durante el deploy.
     */
    const CONFIG = {
      GAS_URL: 'https://script.google.com/macros/s/AKfycbysUzrsV9qlJh2IkVtzXRdU29UPmAIIENJ_fcmX2RYTFHnp81I1qoM70ejzg78mWq5w/exec',
      TOKEN: 'dk3H1YjOJMGfEcAv4TtyTaDBXEZs6oKky5wau3FGRHjTYzQ7Emg6CSHI2aJjR4Hj'
    };

    const COL = { DATE: 0, NAME: 1, CAT: 2, COND: 3, COST: 4, LIST: 5, FLOOR: 6, NOTES: 7, PHOTO: 8, STATUS: 9, SALE_PRICE: 10, SALE_DATE: 11 };
    let items = [];

    function showView(v) {
      document.getElementById('view-dashboard').style.display = (v === 'dashboard' ? 'block' : 'none');
      document.getElementById('view-formulario').style.display = (v === 'formulario' ? 'block' : 'none');
      document.getElementById('btn-nav-dashboard').classList.toggle('active', v === 'dashboard');
      document.getElementById('btn-nav-formulario').classList.toggle('active', v === 'formulario');

      // Si entramos a 'Nuevo' de cero, reseteamos el form
      if (v === 'formulario' && !document.getElementById('form-editing-idx').value) {
        resetForm();
      }

      if (v === 'dashboard') loadData();
    }

    function resetForm() {
      const f = document.getElementById('productForm');
      f.reset();
      f.editingIdx.value = "";
      document.getElementById('form-title').textContent = "Nuevo producto";
      document.getElementById('submitBtn').textContent = "Guardar producto";
      clearPhoto();
    }

    async function apiCall(action, payload = {}) {
      if (typeof google !== 'undefined' && google.script && google.script.run) {
        return new Promise((res, rej) => { google.script.run.withSuccessHandler(res).withFailureHandler(rej)[action](payload); });
      }

      const token = (CONFIG.TOKEN || "").trim();
      const url = CONFIG.GAS_URL + (CONFIG.GAS_URL.includes('?') ? '&' : '?') + 'action=' + action + '&token=' + token;

      console.log("üöÄ Loteando:", action);

      try {
        const isGet = (action === 'getData');
        const options = {
          method: isGet ? 'GET' : 'POST',
          redirect: 'follow'
        };

        if (!isGet) {
          options.body = JSON.stringify({ ...payload, action, token: token });
        }

        const res = await fetch(isGet ? url : CONFIG.GAS_URL, options);
        const data = await res.json();
        if (data.error) throw new Error(data.error);
        return data;
      } catch (e) {
        console.error("‚ùå API Error:", e);
        if (CONFIG.GAS_URL.includes('REPLACE_WITH')) {
          throw new Error("‚ö†Ô∏è Todav√≠a se est√°n configurando los Secrets en GitHub. Esper√° un minuto.");
        }
        if (e.message.includes('fetch')) {
          throw new Error("‚ùå Error de conexi√≥n. Verific√° que la Web App en Google est√© publicada para 'Cualquier persona' (Anyone).");
        }
        throw e;
      }
    }

    window.onload = () => {
      const urlParams = new URLSearchParams(window.location.search);
      if (urlParams.has('token')) { localStorage.setItem('API_TOKEN', urlParams.get('token')); }
      if (typeof CONFIG !== 'undefined' && localStorage.getItem('API_TOKEN')) { CONFIG.TOKEN = localStorage.getItem('API_TOKEN'); }
      loadData();
    };

    async function loadData() {
      const tbody = document.getElementById('tableBody');
      try {
        const data = await apiCall('getData');

        // Si el backend devolvi√≥ un error como string
        if (typeof data === 'string' && data.startsWith('Error')) {
          throw new Error(data);
        }

        // Validar que tengamos un array
        if (!Array.isArray(data)) {
          console.error("Unexpected data format:", data);
          throw new Error("Formato de datos inv√°lido. Revisar configuraci√≥n.");
        }

        items = data.map((row, idx) => ({
          idx: idx + 2, date: row[COL.DATE], name: row[COL.NAME], category: row[COL.CAT],
          condition: parseInt(row[COL.COND]), costPrice: parseFloat(row[COL.COST]) || 0,
          listPrice: parseFloat(row[COL.LIST]) || 0, floorPrice: parseFloat(row[COL.FLOOR]) || 0,
          notes: row[COL.NOTES], photoUrl: row[COL.PHOTO], status: row[COL.STATUS],
          salePrice: row[COL.SALE_PRICE] ? parseFloat(row[COL.SALE_PRICE]) : null,
          createdAt: row[COL.DATE] ? String(row[COL.DATE]).split(' ')[0] : ''
        }));
        renderTable(getFiltered());
      } catch (e) { tbody.innerHTML = `<tr><td colspan="8" style="text-align:center;color:var(--color-danger);padding:36px;">‚ùå ${e.message}</td></tr>`; }
    }

    function renderTable(data) {
      updateStats();
      const tbody = document.getElementById('tableBody');
      document.getElementById('table-count').textContent = data.length + ' items';
      tbody.innerHTML = data.map(i => {
        const isS = i.status === 'Sold';
        const cost = i.costPrice > 0 ? '$' + i.costPrice.toLocaleString() : '‚Äî';
        const price = isS
          ? `<span class="text-accent">$${(i.salePrice || 0).toLocaleString()}</span>`
          : `<div class="td-mono" style="line-height:1.2;">
               <div>$${i.listPrice.toLocaleString()}</div>
               <div class="text-tertiary" style="font-size:10px;">Piso: $${i.floorPrice.toLocaleString()}</div>
             </div>`;
        const badge = isS ? `<span class="badge badge-success">Vendido</span>` : (i.status === 'Deleted' ? `<span class="badge badge-neutral">Archivado</span>` : `<span class="badge badge-warning">Disponible</span>`);

        return `<tr>
                <td class="td-name">${i.name}</td>
                <td><span class="badge badge-neutral">${i.category}</span></td>
                <td class="td-mono">${cost}</td>
                <td>${price}</td>
                <td>${i.costPrice ? '$' + ((isS ? i.salePrice : i.listPrice) - i.costPrice).toLocaleString() : '‚Äî'}</td>
                <td>${daysCell(i)}</td>
                <td>${badge}</td>
                <td><div class="row-actions">
                    ${!isS ? `
                      <button class="action-btn wa" onclick="shareWhatsApp(${i.idx})" title="Compartir WhatsApp">
                        <svg width="16" height="16" fill="currentColor" viewBox="0 0 24 24"><path d="M12.012 2c-5.508 0-9.987 4.479-9.987 9.987 0 1.757.455 3.409 1.25 4.847l-1.327 4.84 4.954-1.301c1.411.769 3.014 1.213 4.717 1.213 5.503 0 9.981-4.478 9.981-9.986 0-5.508-4.478-9.987-9.988-9.987zm.006 18.254c-1.577 0-3.046-.419-4.316-1.149l-.309-.178-3.213.843.858-3.132-.196-.312c-.792-1.264-1.21-2.723-1.21-4.226 0-4.41 3.589-7.999 7.994-7.999 4.411 0 7.994 3.588 7.994 7.999 0 4.411-3.582 7.999-7.994 7.999h-.008z"/></svg>
                      </button>
                      <button class="action-btn sell" onclick="editProduct(${i.idx})" title="Editar Producto">
                        <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7" /><path d="M18.5 2.5a2.121 2.121 0 113 3L12 15l-4 1 1-4 9.5-9.5z" /></svg>
                      </button>
                      <button class="action-btn sell" onclick="openSellModal(${i.idx})" title="Registrar Venta">
                        <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" /></svg>
                      </button>
                      <button class="action-btn delete" onclick="confirmDelete(${i.idx})" title="Archivar">
                        <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                      </button>` : ''}
                </div></td>
            </tr>`;
      }).join('');
    }

    function updateStats() {
      const p = items.filter(i => i.status === 'Pending');
      const s = items.filter(i => i.status === 'Sold');
      document.getElementById('stat-pending').textContent = p.length;
      document.getElementById('stat-sold').textContent = s.length;
      document.getElementById('stat-stock').textContent = '$' + p.reduce((a, b) => a + b.listPrice, 0).toLocaleString();
      document.getElementById('stat-profit').textContent = '$' + s.reduce((a, b) => a + (b.salePrice || 0), 0).toLocaleString();
    }

    function getFiltered() {
      const q = (document.getElementById('search-input')?.value || '').toLowerCase();
      const st = document.getElementById('filter-status')?.value || '';
      return items.filter(i => {
        if (!st && i.status === 'Deleted') return false;
        if (q && !i.name.toLowerCase().includes(q)) return false;
        if (st && i.status !== st) return false;
        return true;
      });
    }
    function applyFilters() { renderTable(getFiltered()); }
    function daysSince(s) { if (!s) return -1; const d = new Date(s); return isNaN(d) ? -1 : Math.floor((Date.now() - d.getTime()) / 86400000); }
    function daysCell(i) { const d = daysSince(i.createdAt); return d < 0 ? '‚Äî' : `<span class="${d > 30 ? 'text-danger' : 'text-secondary'}">${d}d</span>`; }
    function closeModal() { document.getElementById('modal-overlay').classList.remove('open'); }
    function handleOverlayClick(e) { if (e.target.id === 'modal-overlay') closeModal(); }

    function shareWhatsApp(idx) {
      const i = items.find(it => it.idx == idx);
      const cart = "\u{1F6D2}";
      const money = "\u{1F4B0}";
      const camera = "\u{1F4F8}";

      let msg = `${cart} *${i.name}*\n${money} $${i.listPrice.toLocaleString()}\n\n_¬øTe interesa?_`;
      if (i.photoUrl && i.photoUrl.includes('drive.google.com')) {
        msg += `\n\n${camera} Ver foto:\n${i.photoUrl}`;
      }
      window.open(`https://wa.me/?text=${encodeURIComponent(msg)}`, '_blank');
    }

    function confirmDelete(idx) {
      const i = items.find(it => it.idx == idx);
      document.getElementById('modal-title').textContent = 'Archivar producto';
      document.getElementById('modal-body').innerHTML = `<p>¬øEst√°s seguro de que quieres archivar <b>${i.name}</b>?</p><p class="text-secondary" style="font-size:var(--text-xs);margin-top:var(--sp-2);">El item dejar√° de verse en el dashboard principal pero quedar√° en el Sheet.</p>`;
      document.getElementById('modal-footer').innerHTML = `<button class="btn btn-secondary" onclick="closeModal()">Cancelar</button><button class="btn btn-danger" onclick="doDelete(${idx})">Archivar ahora</button>`;
      document.getElementById('modal-overlay').classList.add('open');
    }

    async function doDelete(idx) {
      closeModal();
      await apiCall('softDelete', { rowIndex: idx });
      loadData();
    }

    function editProduct(idx) {
      const i = items.find(it => it.idx == idx);
      const f = document.getElementById('productForm');

      f.editingIdx.value = i.idx;
      f.productName.value = i.name;
      f.category.value = i.category;
      f.condition.value = i.condition;
      f.costPrice.value = i.costPrice || 0;
      f.publicPrice.value = i.listPrice;
      f.minPrice.value = i.floorPrice;
      f.notes.value = i.notes || "";

      document.getElementById('form-title').textContent = "Editar producto";
      document.getElementById('submitBtn').textContent = "Actualizar producto";

      if (i.photoUrl && i.photoUrl.includes('http')) {
        document.getElementById('image-preview-container').style.display = 'block';
        document.getElementById('image-preview').style.display = 'none';
        document.getElementById('image-link-container').style.display = 'block';
        document.getElementById('image-direct-link').href = i.photoUrl;
      } else {
        clearPhoto();
      }

      showView('formulario');
    }

    function openSellModal(idx) {
      const i = items.find(it => it.idx == idx);
      document.getElementById('modal-title').textContent = 'Venta: ' + i.name;
      document.getElementById('modal-body').innerHTML = `<input type="number" id="m-price" class="form-control" value="${i.listPrice}" />`;
      document.getElementById('modal-footer').innerHTML = `<button class="btn btn-primary" onclick="doSell(${idx})">Confirmar</button>`;
      document.getElementById('modal-overlay').classList.add('open');
    }
    async function doSell(idx) {
      const p = document.getElementById('m-price').value;
      closeModal();
      await apiCall('markSold', { rowIndex: idx, salePrice: p });
      loadData();
    }
    function previewImage(i) {
      if (i.files[0]) {
        const r = new FileReader();
        r.onload = e => {
          document.getElementById('image-preview').src = e.target.result;
          document.getElementById('image-preview').style.display = 'block';
          document.getElementById('image-link-container').style.display = 'none';
          document.getElementById('image-preview-container').style.display = 'block';
        };
        r.readAsDataURL(i.files[0]);
      }
    }
    function clearPhoto() {
      document.getElementById('photo').value = '';
      document.getElementById('image-preview-container').style.display = 'none';
      document.getElementById('image-preview').style.display = 'none';
      document.getElementById('image-link-container').style.display = 'none';
    }
    async function startUpload() {
      const f = document.getElementById('productForm');
      const st = document.getElementById('status');
      st.innerHTML = '‚è≥ Guardando‚Ä¶';
      const file = document.getElementById('photo').files[0];
      const save = async (b64 = null) => {
        const payload = {
          productName: f.productName.value,
          category: f.category.value,
          condition: f.condition.value,
          costPrice: f.costPrice.value,
          publicPrice: f.publicPrice.value,
          minPrice: f.minPrice.value,
          notes: f.notes.value,
          imageBlob: b64,
          rowIndex: f.editingIdx.value
        };

        const action = f.editingIdx.value ? 'updateProduct' : 'processForm';
        await apiCall(action, payload);

        f.reset();
        clearPhoto();
        st.innerHTML = '‚úÖ!';
        setTimeout(() => showView('dashboard'), 1000);
      };
      if (file) { const r = new FileReader(); r.onload = e => save(e.target.result); r.readAsDataURL(file); } else save();
    }
  </script>
</body>

</html>