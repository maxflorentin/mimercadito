<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inventario ‚Äî miMercadito</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
    <?!= include('theme') ?>
</head>

<body>

    <!-- Navbar -->
    <div class="preview-nav">
        <div class="preview-brand">miMercadito <span>¬∑ inventory</span></div>
        <div class="tab-group">
            <button class="tab-btn active">Dashboard</button>
            <button class="tab-btn"
                onclick="window.top.location.href='<?!= getScriptUrl() ?>?p=Formulario'">Nuevo</button>
        </div>
    </div>

    <div class="page">
        <!-- Stat cards -->
        <div class="stat-grid" style="margin-bottom:var(--sp-5);">
            <div class="stat-card">
                <p class="stat-label">En venta</p>
                <p class="stat-value" id="stat-pending">‚Äî</p>
            </div>
            <div class="stat-card">
                <p class="stat-label">Vendidos</p>
                <p class="stat-value text-accent" id="stat-sold">‚Äî</p>
            </div>
            <div class="stat-card">
                <p class="stat-label">Stock valorizado</p>
                <p class="stat-value" id="stat-stock">‚Äî</p>
            </div>
            <div class="stat-card">
                <p class="stat-label">Ingreso ventas</p>
                <p class="stat-value text-success" id="stat-profit">‚Äî</p>
            </div>
            <div class="stat-card">
                <p class="stat-label">Prom. d√≠as stock</p>
                <p class="stat-value text-warning" id="stat-avgdays">‚Äî</p>
            </div>
        </div>

        <!-- Table card -->
        <div class="card" style="padding:0;overflow:hidden;">
            <div class="flex items-center justify-between"
                style="padding:var(--sp-5) var(--sp-5) var(--sp-4);flex-wrap:wrap;gap:var(--sp-3);">
                <p class="text-subtitle">Productos</p>
                <div class="toolbar">
                    <div class="search-wrap" style="position:relative;flex:1;min-width:140px;">
                        <svg width="13" height="13" fill="none" stroke="currentColor" stroke-width="2"
                            viewBox="0 0 24 24"
                            style="position:absolute;left:10px;top:50%;transform:translateY(-50%);color:var(--color-text-tertiary);pointer-events:none;">
                            <circle cx="11" cy="11" r="8" />
                            <path d="m21 21-4.35-4.35" />
                        </svg>
                        <input type="text" class="search-input" placeholder="Buscar‚Ä¶" oninput="applyFilters()"
                            id="search-input"
                            style="width:100%;padding:7px 12px 7px 32px;font-family:var(--font);font-size:var(--text-sm);color:var(--color-text-primary);background:var(--color-surface-solid);border:1px solid var(--color-border);border-radius:var(--r-md);outline:none;" />
                    </div>
                    <div class="filter-wrap" style="position:relative;">
                        <select class="filter-select" onchange="applyFilters()" id="filter-status"
                            style="padding:7px 28px 7px 10px;font-family:var(--font);font-size:var(--text-sm);color:var(--color-text-secondary);background:var(--color-surface-solid);border:1px solid var(--color-border);border-radius:var(--r-md);outline:none;cursor:pointer;appearance:none;">
                            <option value="">Todos</option>
                            <option value="Pending">En venta</option>
                            <option value="Sold">Vendidos</option>
                            <option value="Deleted">Archivados</option>
                        </select>
                        <svg width="10" height="10" fill="none" stroke="currentColor" stroke-width="2.5"
                            viewBox="0 0 24 24"
                            style="position:absolute;right:8px;top:50%;transform:translateY(-50%);color:var(--color-text-tertiary);pointer-events:none;">
                            <path d="m6 9 6 6 6-6" />
                        </svg>
                    </div>
                    <span id="table-count" class="badge badge-neutral">‚Äî items</span>
                </div>
            </div>
            <div style="border-top:1px solid var(--color-border);overflow-x:auto;">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Producto</th>
                            <th>Categor√≠a</th>
                            <th>Costo</th>
                            <th>Lista / Piso</th>
                            <th>Margen</th>
                            <th>D√≠as</th>
                            <th>Estado</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody id="tableBody">
                        <tr>
                            <td colspan="8" style="text-align:center;color:var(--color-text-tertiary);padding:36px;">‚è≥
                                Cargando datos del Spreadsheet‚Ä¶</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Modal -->
    <div class="modal-overlay" id="modal-overlay" onclick="handleOverlayClick(event)">
        <div class="modal" id="modal">
            <div class="modal-header">
                <p class="modal-title" id="modal-title">‚Äî</p>
                <p class="modal-subtitle" id="modal-subtitle"></p>
            </div>
            <div class="modal-body" id="modal-body"></div>
            <div class="modal-footer" id="modal-footer"></div>
        </div>
    </div>

    <div class="toast-stack" id="toast-stack"></div>

    <script>
        const COL = { DATE: 0, NAME: 1, CAT: 2, COND: 3, COST: 4, LIST: 5, FLOOR: 6, NOTES: 7, PHOTO: 8, STATUS: 9, SALE_PRICE: 10, SALE_DATE: 11 };
        let items = [];

        window.onload = () => { loadData(); };

        function loadData() {
            const tbody = document.getElementById('tableBody');
            google.script.run
                .withSuccessHandler(data => {
                    if (typeof data === 'string' && data.startsWith('Error')) {
                        tbody.innerHTML = `<tr><td colspan="8" style="text-align:center;color:var(--color-danger);padding:36px;">‚ö†Ô∏è ${data}</td></tr>`;
                        return;
                    }
                    if (!data || !Array.isArray(data)) {
                        tbody.innerHTML = `<tr><td colspan="8" style="text-align:center;color:var(--color-text-tertiary);padding:36px;">No se encontraron datos.</td></tr>`;
                        return;
                    }
                    try {
                        items = data.map((row, idx) => {
                            // Defensive parsing to prevent crash if cell is weird
                            const nPrice = (v) => isNaN(parseFloat(v)) ? 0 : parseFloat(v);
                            return {
                                idx: idx + 2,
                                date: row[COL.DATE] || '',
                                name: row[COL.NAME] || 'Sin nombre',
                                category: row[COL.CAT] || 'Other',
                                condition: parseInt(row[COL.COND]) || 10,
                                costPrice: nPrice(row[COL.COST]),
                                listPrice: nPrice(row[COL.LIST]),
                                floorPrice: nPrice(row[COL.FLOOR]),
                                notes: row[COL.NOTES] || '',
                                photoUrl: row[COL.PHOTO] || '',
                                status: row[COL.STATUS] || 'Pending',
                                salePrice: row[COL.SALE_PRICE] ? nPrice(row[COL.SALE_PRICE]) : null,
                                saleDate: row[COL.SALE_DATE] || '',
                                createdAt: row[COL.DATE] ? String(row[COL.DATE]).split(' ')[0] : ''
                            };
                        });
                        renderTable(getFiltered());
                    } catch (e) {
                        tbody.innerHTML = `<tr><td colspan="8" style="text-align:center;color:var(--color-danger);padding:36px;">‚ùå Error procesando: ${e.message}</td></tr>`;
                    }
                })
                .withFailureHandler(err => {
                    tbody.innerHTML = `<tr><td colspan="8" style="text-align:center;color:var(--color-danger);padding:36px;">‚ùå Error de conexi√≥n: ${err}</td></tr>`;
                })
                .getInventoryData();
        }

        function updateStats() {
            const pending = items.filter(i => i.status === 'Pending');
            const sold = items.filter(i => i.status === 'Sold');
            const stockVal = pending.reduce((s, i) => s + i.listPrice, 0);
            const revenue = sold.reduce((s, i) => s + (i.salePrice || 0), 0);
            const daysArr = pending.map(i => daysSince(i.createdAt)).filter(d => d >= 0);
            const avgDays = daysArr.length ? Math.round(daysArr.reduce((a, b) => a + b, 0) / daysArr.length) : 0;

            document.getElementById('stat-pending').textContent = pending.length;
            document.getElementById('stat-sold').textContent = sold.length;
            document.getElementById('stat-stock').textContent = '$' + stockVal.toLocaleString('es-AR');
            document.getElementById('stat-profit').textContent = '$' + revenue.toLocaleString('es-AR');
            document.getElementById('stat-avgdays').textContent = avgDays + 'd';
        }

        function getFiltered() {
            const q = (document.getElementById('search-input')?.value || '').toLowerCase();
            const st = document.getElementById('filter-status')?.value || '';
            return items.filter(i => {
                if (!st && i.status === 'Deleted') return false;
                if (q && !i.name.toLowerCase().includes(q) && !i.notes.toLowerCase().includes(q)) return false;
                if (st && i.status !== st) return false;
                return true;
            });
        }
        function applyFilters() { renderTable(getFiltered()); }

        function daysSince(dateStr) {
            if (!dateStr) return -1;
            const d = new Date(dateStr);
            return isNaN(d) ? -1 : Math.floor((Date.now() - d.getTime()) / 86400000);
        }

        function daysCell(item) {
            const d = daysSince(item.createdAt);
            if (d < 0) return '<span class="text-tertiary">‚Äî</span>';
            if (item.status === 'Sold') return `<span class="text-tertiary" style="font-size:var(--text-xs);">${d}d</span>`;
            const cls = d > 30 ? 'text-danger' : d > 14 ? 'text-warning' : 'text-secondary';
            return `<span class="${cls}" style="font-size:var(--text-xs);font-weight:600;">${d}d</span>`;
        }

        function renderTable(data) {
            updateStats();
            const tbody = document.getElementById('tableBody');
            document.getElementById('table-count').textContent = data.length + ' items';

            if (!data.length) {
                tbody.innerHTML = `<tr><td colspan="8" style="text-align:center;color:var(--color-text-tertiary);padding:36px;">Sin productos.</td></tr>`;
                return;
            }

            tbody.innerHTML = data.map(item => {
                const isSold = item.status === 'Sold';
                const isDeleted = item.status === 'Deleted';
                const hasCost = item.costPrice > 0;
                const potMargin = hasCost ? item.listPrice - item.costPrice : null;
                const potPct = hasCost && item.listPrice > 0 ? Math.round((potMargin / item.listPrice) * 100) : null;
                const realProfit = isSold && hasCost ? (item.salePrice - item.costPrice) : null;

                const marginCell = isSold
                    ? realProfit !== null
                        ? `<span class="text-success td-mono" style="font-weight:500;">+$${realProfit.toLocaleString('es-AR')}</span>`
                        : `<span class="text-tertiary">‚Äî</span>`
                    : potMargin !== null
                        ? `<span class="td-mono" style="font-weight:500;">$${potMargin.toLocaleString('es-AR')}</span> <span class="text-tertiary" style="font-size:var(--text-xs);">${potPct}%</span>`
                        : `<span class="text-tertiary">‚Äî</span>`;

                const statusBadge = isSold ? `<span class="badge badge-success">Vendido</span>` : isDeleted ? `<span class="badge badge-neutral">Archivado</span>` : `<span class="badge badge-warning">En venta</span>`;
                const costCell = item.costPrice > 0 ? `$${item.costPrice.toLocaleString('es-AR')}` : `<span class="text-tertiary">‚Äî</span>`;
                const priceCell = isSold ? `<span class="td-mono text-accent" style="font-weight:500;">$${(item.salePrice || 0).toLocaleString('es-AR')}</span>` : `<span class="td-mono">$${item.listPrice.toLocaleString('es-AR')}</span>`;

                return `<tr class="${isSold || isDeleted ? 'row-faded' : ''}">
          <td class="td-name">${escHtml(item.name)}${item.notes ? `<br><span class="text-tertiary" style="font-size:var(--text-xs);font-weight:400;">${escHtml(item.notes)}</span>` : ''}</td>
          <td><span class="badge badge-neutral">${item.category}</span></td>
          <td class="td-mono text-secondary">${costCell}</td>
          <td>${priceCell}</td>
          <td>${marginCell}</td>
          <td>${daysCell(item)}</td>
          <td>${statusBadge}</td>
          <td>
            <div class="row-actions">
              ${(!isSold && !isDeleted) ? `
                <button class="action-btn wa" onclick="shareWhatsApp('${item.idx}')" title="WhatsApp"><svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347z"/><path d="M12 0C5.373 0 0 5.373 0 12c0 2.126.558 4.121 1.529 5.847L0 24l6.338-1.502A11.93 11.93 0 0 0 12 24c6.627 0 12-5.373 12-12S18.627 0 12 0zm0 21.818a9.779 9.779 0 0 1-5.003-1.373l-.36-.214-3.727.883.935-3.625-.235-.374A9.778 9.778 0 0 1 2.182 12C2.182 6.57 6.57 2.182 12 2.182S21.818 6.57 21.818 12 17.43 21.818 12 21.818z"/></svg></button>
                <button class="action-btn sell" onclick="openSellModal('${item.idx}')" title="Vendido"><svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2.2" viewBox="0 0 24 24"><path d="M20 6 9 17l-5-5"/></svg></button>
              ` : ''}
              ${!isDeleted ? `<button class="action-btn delete" onclick="openArchiveModal('${item.idx}')"><svg width="13" height="13" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6"/><path d="M10 11v6M14 11v6"/></svg></button>` : `<button class="action-btn" onclick="restoreItem('${item.idx}')" style="color:var(--color-accent);"><svg width="13" height="13" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M3.51 15a9 9 0 1 0 .49-3"/></svg></button>`}
            </div>
          </td>
        </tr>`;
            }).join('');
        }

        function openModal() { document.getElementById('modal-overlay').classList.add('open'); }
        function closeModal() { document.getElementById('modal-overlay').classList.remove('open'); }
        function handleOverlayClick(e) { if (e.target.id === 'modal-overlay') closeModal(); }
        function setModal({ title, subtitle, body, footer }) {
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-subtitle').textContent = subtitle || '';
            document.getElementById('modal-body').innerHTML = body;
            document.getElementById('modal-footer').innerHTML = footer;
            openModal();
        }
        function toast(msg, type = '') {
            const el = document.createElement('div');
            el.className = 'toast ' + type;
            el.textContent = msg;
            document.getElementById('toast-stack').appendChild(el);
            setTimeout(() => el.remove(), 3000);
        }
        function escHtml(s = '') { return String(s).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;'); }

        function openSellModal(idx) {
            const item = items.find(i => i.idx == idx);
            setModal({
                title: 'Cerrar venta',
                subtitle: item.name,
                body: `<div class="form-group"><label class="form-label">Precio venta ($)</label><input type="number" id="modal-sale-price" class="form-control" value="${item.listPrice}" /></div>`,
                footer: `<button class="btn btn-secondary" onclick="closeModal()">Cancelar</button><button class="btn btn-primary" onclick="confirmSell('${idx}')">Confirmar</button>`
            });
        }

        function confirmSell(idx) {
            const price = parseFloat(document.getElementById('modal-sale-price').value);
            if (!price) return toast('Ingres√° precio', 'error');
            closeModal();
            google.script.run.withSuccessHandler(() => location.reload()).markSold(parseInt(idx), price);
        }

        function openArchiveModal(idx) {
            const item = items.find(i => i.idx == idx);
            setModal({
                title: 'Archivar',
                subtitle: item.name,
                body: `<p style="font-size:var(--text-sm);">¬øArchivar este producto?</p>`,
                footer: `<button class="btn btn-secondary" onclick="closeModal()">No</button><button class="btn btn-danger" onclick="confirmArchive('${idx}')">S√≠, archivar</button>`
            });
        }

        function confirmArchive(idx) {
            closeModal();
            google.script.run.withSuccessHandler(() => location.reload()).softDelete(parseInt(idx));
        }

        function shareWhatsApp(idx) {
            const item = items.find(i => i.idx == idx);
            const msg = `üõí *${item.name}*\nüí∞ $${item.listPrice.toLocaleString('es-AR')}\n\n_¬øTe interesa?_`;
            const url = item.photoUrl ? `\n\nüì∏ ${item.photoUrl}` : '';
            if (navigator.share) navigator.share({ title: item.name, text: msg + url });
            else window.open(`https://wa.me/?text=${encodeURIComponent(msg + url)}`, '_blank');
        }
    </script>
</body>

</html>