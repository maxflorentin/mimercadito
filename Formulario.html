<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nuevo Producto — ventas2026</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
    <?!= include('theme') ?>
</head>

<body>

    <!-- Navbar -->
    <div class="preview-nav">
        <div class="preview-brand">ventas2026 <span>· inventory</span></div>
        <div class="tab-group">
            <button class="tab-btn"
                onclick="window.top.location.href='<?!= getScriptUrl() ?>?p=Dashboard'">Dashboard</button>
            <button class="tab-btn active">Nuevo</button>
        </div>
    </div>

    <div class="page-narrow">
        <div style="margin-bottom:var(--sp-6);">
            <h1 class="text-title">Nuevo producto</h1>
            <p class="text-secondary" style="font-size:var(--text-sm);margin-top:2px;">Cargá los datos del nuevo item.
            </p>
        </div>

        <div class="card">
            <form id="productForm" class="flex flex-col gap-4">
                <div class="form-group">
                    <label class="form-label">Nombre del producto</label>
                    <input type="text" name="productName" class="form-control" placeholder="MacBook Pro, iPhone 15…"
                        required />
                </div>

                <div class="grid-2">
                    <div class="form-group">
                        <label class="form-label">Categoría</label>
                        <select name="category" class="form-select form-control">
                            <option>Electronics</option>
                            <option>Home</option>
                            <option>Fashion</option>
                            <option>Other</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Estado (1–10)</label>
                        <input type="number" name="condition" class="form-control" min="1" max="10" value="10" />
                    </div>
                </div>

                <div class="grid-3">
                    <div class="form-group">
                        <label class="form-label">Costo compra ($)</label>
                        <input type="number" name="costPrice" class="form-control" placeholder="Opcional" />
                    </div>
                    <div class="form-group">
                        <label class="form-label">Precio lista ($)</label>
                        <input type="number" name="publicPrice" class="form-control" placeholder="0" required />
                    </div>
                    <div class="form-group">
                        <label class="form-label">Precio piso ($)</label>
                        <input type="number" name="minPrice" class="form-control" placeholder="0" required />
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Notas / Accesorios</label>
                    <input type="text" name="notes" class="form-control" placeholder="Ej: Con caja y cables…" />
                </div>

                <div class="form-group">
                    <label class="form-label">Foto del producto</label>
                    <label for="photo" class="btn btn-secondary w-full"
                        style="height:auto;padding:16px;border-style:dashed;flex-direction:column;gap:var(--sp-2);">
                        <svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="2"
                            viewBox="0 0 24 24">
                            <path
                                d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z" />
                            <circle cx="12" cy="13" r="4" />
                        </svg>
                        <span id="photo-label">Tocar para sacar foto</span>
                        <input type="file" id="photo" class="form-control" style="display:none;" accept="image/*"
                            capture="environment" onchange="previewImage(this)" />
                    </label>
                    <div id="image-preview-container" style="display:none;margin-top:var(--sp-2);position:relative;">
                        <img id="image-preview" src="" style="width:100%;border-radius:var(--r-md);display:block;" />
                        <button type="button" onclick="clearPhoto()"
                            style="position:absolute;top:8px;right:8px;background:rgba(0,0,0,0.5);color:white;border:none;border-radius:50%;width:24px;height:24px;cursor:pointer;">✕</button>
                    </div>
                </div>

                <div style="margin-top:var(--sp-2);">
                    <button type="button" id="submitBtn" class="btn btn-primary w-full" onclick="startUpload()">
                        Guardar producto
                    </button>
                </div>

                <div id="status" style="min-height:36px;"></div>
            </form>
        </div>
    </div>

    <script>
        function previewImage(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    document.getElementById('image-preview').src = e.target.result;
                    document.getElementById('image-preview-container').style.display = 'block';
                    document.getElementById('photo-label').textContent = 'Foto lista';
                };
                reader.readAsDataURL(input.files[0]);
            }
        }

        function clearPhoto() {
            document.getElementById('photo').value = '';
            document.getElementById('image-preview-container').style.display = 'none';
            document.getElementById('photo-label').textContent = 'Tocar para sacar foto';
        }

        function startUpload() {
            const btn = document.getElementById('submitBtn');
            const status = document.getElementById('status');
            const fileInput = document.getElementById('photo');
            const form = document.getElementById('productForm');

            if (!form.checkValidity()) {
                status.innerHTML = `<div class="status-msg error">Por favor completá todos los campos obligatorios.</div>`;
                return;
            }

            btn.disabled = true;
            status.innerHTML = `<div class="status-msg loading">⏳ Guardando producto…</div>`;

            const file = fileInput.files[0];
            const sendData = (base64Photo = null) => {
                const formObject = {
                    productName: form.productName.value.trim(),
                    category: form.category.value,
                    condition: form.condition.value,
                    costPrice: form.costPrice.value,
                    publicPrice: form.publicPrice.value,
                    minPrice: form.minPrice.value,
                    notes: form.notes.value.trim(),
                    imageBlob: base64Photo
                };

                google.script.run
                    .withSuccessHandler(r => {
                        status.innerHTML = `<div class="status-msg success">${r}</div>`;
                        form.reset();
                        clearPhoto();
                        btn.disabled = false;
                        setTimeout(() => {
                            window.top.location.href = '<?!= getScriptUrl() ?>?p=Dashboard';
                        }, 1200);
                    })
                    .withFailureHandler(err => {
                        status.innerHTML = `<div class="status-msg error">❌ Error: ${err}</div>`;
                        btn.disabled = false;
                    })
                    .processForm(formObject);
            };

            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => sendData(e.target.result);
                reader.readAsDataURL(file);
            } else {
                sendData();
            }
        }
    </script>
</body>

</html>